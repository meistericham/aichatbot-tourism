<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sarawak AI Tourism Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    body {
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: #111;
      color: #fff;
      font-family: "Segoe UI", Arial, sans-serif;
      min-height: 100vh;
    }

    /* Header */
    header {
      position: relative;
      text-align: center;
      padding: 20px 15px;
      background: url("https://i.ibb.co/RGVs3mQn/DUN-AI-revised.png") no-repeat center/cover;
      color: #fff;
    }
    header::before { content:""; position:absolute; inset:0; background:rgba(0,0,0,.55); }
    header .inner { position:relative; z-index:1; max-width:1080px; margin:0 auto; }
    header img { max-width:180px; margin-bottom:6px; }
    @media (max-width:600px){ header img{ max-width:150px; } }
    header h1 { font-size:22px; font-weight:800; text-shadow:1px 1px 4px rgba(0,0,0,.7); margin:5px 0; }
    header p.sub { font-size:13px; opacity:.9; }

    /* Chat card */
    #chatCard {
      max-width: 1080px;
      width: 92%;
      margin: 24px auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      display: flex;
      flex-direction: column;
      height: 72vh;
      min-height: 560px;
      overflow: hidden;
      position: relative;
    }

    /* Welcome/instruction panel (inside the white card, above chat) */
    #welcomeNote {
      position: absolute;
      top: 12px; left: 12px; right: 12px;
      z-index: 2;
      background: #f6f9ff;
      border: 1px solid #e5edff;
      color: #26324b;
      padding: 14px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }
    #welcomeNote.hidden { display:none; }

    /* Chat host */
    #n8n-chat { flex: 1; display: flex; flex-direction: column; min-height: 0; }

    /* Ensure messages area scrolls; keep input/footer visible */
    #n8n-chat .messages { flex: 1; overflow-y: auto; padding: 20px; }
    #n8n-chat .chat-footer {
      display: flex !important;
      visibility: visible !important;
      background: #fff !important;
      border-top: 1px solid #eee !important;
      padding: 12px !important;
    }
    #n8n-chat .chat-input { width: 100%; display: flex; }
    #n8n-chat .chat-input textarea {
      flex: 1;
      border: 1px solid #ddd !important;
      border-radius: 20px !important;
      padding: 10px 14px !important;
      font-size: 15px;
      resize: none;
      min-height: 44px;
      max-height: 140px;
    }
    #n8n-chat .chat-input button {
      margin-left: 8px;
      width: 44px; height: 44px;
      border-radius: 50%;
      background: #111 !important; color: #fff !important;
    }

    /* Hide n8n branding & launcher */
    #n8n-chat .chat-header,
    #n8n-chat [data-testid="powered-by"],
    #n8n-chat .powered-by,
    .n8n-chat .powered-by,
    #n8n-chat [data-testid="launcher"],
    .chat-launcher { display:none !important; }

    /* System messages (cooldown notices inside chat) */
    #n8n-chat .message.system {
      text-align: center;
      font-size: 13px;
      color: #666 !important;
      font-style: italic;
      margin: 6px 0;
    }

    /* Cooldown banner (top-right inside card) */
    #cooldownBanner {
      position: absolute; right: 12px; top: 12px; z-index: 3;
      background: #111; color:#fff;
      font-size: 12px; padding: 8px 10px; border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      display: none;
    }
    #cooldownBanner.show { display:block; }

    /* Footer */
    footer {
      background: #111; text-align: center; padding: 10px;
      font-size: 13px; color: #aaa; border-top: 1px solid #222;
    }
    footer span { color: #f0f0f0; font-weight: 500; }
    footer a { color:#fff; text-decoration:underline; }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <a href="https://sarawaktourism.com" target="_blank" rel="noopener">
        <img src="https://sarawakharvestfestival.com.my/wp-content/uploads/2025/05/Sarawak-More-to-Discover-min.png" alt="Sarawak Tourism Logo" />
      </a>
      <h1>Sarawak AI Tourism Assistant</h1>
      <p class="sub">Tanya apa-apa tentang destinasi, acara, dan tip perjalanan di Sarawak.</p>
    </div>
  </header>

  <section id="chatCard">
    <!-- Cooldown toast -->
    <div id="cooldownBanner" aria-live="polite">‚è≥ Tunggu 10 saat antara soalan.</div>

    <!-- Always-visible instructions (hide after first real message appears) -->
    <div id="welcomeNote">
      <strong>Selamat datang! üëã</strong><br>
      Tanyakan apa sahaja tentang Kuching &amp; Sarawak (makanan, tempat, pengangkutan, waktu operasi).<br>
      ‚Ä¢ Jangan spam ‚Äî satu mesej pada satu masa.<br>
      ‚Ä¢ Ada <strong>cooldown 10 saat</strong> selepas anda menghantar soalan.<br>
      ‚Ä¢ Pautan yang dikongsi akan boleh diklik.
    </div>

    <!-- n8n chat mounts here -->
    <div id="n8n-chat"></div>
  </section>

  <footer>
    Concept by <span><a href="https://mohdhisyamudin.com" target="_blank" rel="noopener">Mohd Hisyamudin</a></span> | Powered by <span>AI</span>
  </footer>

  <script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    const WEBHOOK_URL = 'https://n8n.meistericham.com/webhook/cfc0414c-8105-427f-bc13-b0ca2df2b8b8/chat';
    const COOLDOWN_MS = 10_000;         // 10s between sends
    const FAILSAFE_UNLOCK_MS = 25_000;  // auto-unlock if no assistant msg
    const IDLE_RESET_MIN = 3;           // auto-clear session lock after 3 mins idle

    // ----- Helpers -----
    const $ = (sel, root=document) => root.querySelector(sel);
    const show = el => el && el.classList.add('show');
    const hide = el => el && el.classList.remove('show');

    // Add a grey system message inside the chat
    function injectSystemMessage(text) {
      const messages = $('#n8n-chat .messages');
      if (!messages) return;
      const div = document.createElement('div');
      div.className = 'message system';
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // Hide welcome note once first real message appears
    function installWelcomeAutoHide() {
      const note = $('#welcomeNote');
      const host = $('#n8n-chat');
      if (!note || !host) return;
      const mo = new MutationObserver(() => {
        const hasChatMsg = host.querySelector('.message');
        if (hasChatMsg) { note.classList.add('hidden'); mo.disconnect(); }
      });
      mo.observe(host, { childList: true, subtree: true });
    }

    // Session lock: one active session per device
    const SESSION_KEY = 'sam_session_locked';
    const LAST_ACTIVITY = 'sam_last_activity';
    function isLocked() {
      const lock = localStorage.getItem(SESSION_KEY);
      const last = Number(localStorage.getItem(LAST_ACTIVITY) || 0);
      const idleTooLong = Date.now() - last > IDLE_RESET_MIN * 60_000;
      if (idleTooLong) { localStorage.removeItem(SESSION_KEY); }
      return !!localStorage.getItem(SESSION_KEY);
    }
    function lockSession() {
      localStorage.setItem(SESSION_KEY, '1');
      localStorage.setItem(LAST_ACTIVITY, String(Date.now()));
    }
    function touchSession() {
      localStorage.setItem(LAST_ACTIVITY, String(Date.now()));
    }
    function unlockSession() {
      localStorage.removeItem(SESSION_KEY);
    }

    // Cooldown & duplicate guards
    let lastSendAt = 0;
    let lastText = '';
    let inFlight = false;

    function cooldownRemaining() {
      return Math.max(0, COOLDOWN_MS - (Date.now() - lastSendAt));
    }

    function blockIfCooling(e) {
      const rem = cooldownRemaining();
      if (rem > 0 || inFlight) {
        e?.preventDefault();
        // Banner + system line
        $('#cooldownBanner').textContent = `‚è≥ Sila tunggu ${Math.ceil(rem/1000)} saat sebelum hantar soalan baharu.`;
        show($('#cooldownBanner'));
        setTimeout(() => hide($('#cooldownBanner')), 1200);
        injectSystemMessage(`‚è≥ Sila tunggu ${Math.ceil(rem/1000)} saat sebelum hantar soalan baru.`);
        return true;
      }
      return false;
    }

    function installGuards() {
      const root = document.getElementById('n8n-chat');
      if (!root) return;

      const box = () => root.querySelector('textarea, input[type="text"]');
      const sendBtn = () => root.querySelector('.chat-input button');
      const disable = on => { box() && (box().disabled = on); sendBtn() && (sendBtn().disabled = on); };

      // Unlock when any assistant message shows up (heuristic)
      const mo = new MutationObserver(() => {
        if (!inFlight) return;
        const botMsg = root.querySelector('.message.assistant, .assistant, .bot');
        if (botMsg) { inFlight = false; disable(false); touchSession(); }
      });
      mo.observe(root, { childList: true, subtree: true });

      // Safety unlock in case stream stalls
      const safety = () => setTimeout(() => { inFlight = false; disable(false); }, FAILSAFE_UNLOCK_MS);

      // Intercept Enter in the input
      root.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        const b = box();
        const val = (b?.value || '').trim();
        if (!val) { e.preventDefault(); return; }

        // One session per device
        if (isLocked() === false) { lockSession(); }
        else { touchSession(); }

        // Cooldown / inflight
        if (blockIfCooling(e)) return;

        // Duplicate guard (same text within cooldown window)
        if (val === lastText && Date.now() - lastSendAt < COOLDOWN_MS) {
          e.preventDefault();
          injectSystemMessage('‚ö†Ô∏è Mesej yang sama telah dihantar. Cuba ubah soalan anda.');
          return;
        }

        // Commit send: mark in-flight & timestamp
        inFlight = true;
        lastSendAt = Date.now();
        lastText = val;
        disable(true);
        safety();
      }, true);

      // Also intercept mouse click on send button
      root.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        if (!t.closest('.chat-input button')) return;

        const b = box();
        const val = (b?.value || '').trim();
        if (!val) { e.preventDefault(); return; }

        if (isLocked() === false) { lockSession(); }
        else { touchSession(); }

        if (blockIfCooling(e)) return;

        if (val === lastText && Date.now() - lastSendAt < COOLDOWN_MS) {
          e.preventDefault();
          injectSystemMessage('‚ö†Ô∏è Mesej yang sama telah dihantar. Cuba ubah soalan anda.');
          return;
        }

        inFlight = true;
        lastSendAt = Date.now();
        lastText = val;
        disable(true);
        setTimeout(() => { inFlight = false; disable(false); }, FAILSAFE_UNLOCK_MS);
      }, true);

      // Idle unlock (3 minutes)
      setInterval(() => {
        const last = Number(localStorage.getItem(LAST_ACTIVITY) || 0);
        if (Date.now() - last > IDLE_RESET_MIN * 60_000) {
          unlockSession();
          injectSystemMessage('‚ÑπÔ∏è Sesi dinyahaktif selepas tidak aktif. Anda boleh sambung bersembang.');
        }
      }, 30_000);
    }

    // ----- Initialize chat -----
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await createChat({
          webhookUrl: WEBHOOK_URL,
          target: '#n8n-chat',
          mode: 'embedded',
          showWelcomeScreen: false,
          enableStreaming: true,
          loadPreviousSession: true,
          initialMessages: [
            'Selamat datang! üëã Saya Sam Izrin.',
            'Tanya apa-apa pasal Kuching & Sarawak: tempat menarik, makanan, waktu operasi, pengangkutan.',
            'Contoh: ‚ÄúBila show Darul Hana fountain?‚Äù, ‚ÄúMacam mana pergi Bako?‚Äù, ‚ÄúDi mana beli kek lapis?‚Äù'
          ],
          i18n: {
            en: { inputPlaceholder: 'Tanya soalan di sini‚Ä¶ contoh: ‚ÄúWaktu fountain Darul Hana‚Äù' }
          }
        });

        installGuards();
        installWelcomeAutoHide();

      } catch (err) {
        console.error('Failed to initialize chat:', err);
        const note = document.getElementById('welcomeNote');
        if (note) {
          note.innerHTML = '<strong>Ralat memuatkan chat.</strong> Sila muat semula halaman.';
        }
      }
    });
  </script>
</body>
</html>
