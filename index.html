<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sarawak AI Tourism Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- n8n Chat CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    body {
      display: grid;
      grid-template-rows: auto 1fr auto; /* header, chat, footer */
      background: #111;
      color: #fff;
      font-family: "Segoe UI", Arial, sans-serif;
      min-height: 100vh;
    }

    /* Header */
    header {
      position: relative;
      text-align: center;
      padding: 18px 12px;
      background: url("https://i.ibb.co/RGVs3mQn/DUN-AI-revised.png") no-repeat center/cover;
      color: #fff;
    }
    header::before {
      content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.5);
    }
    header .inner {
      position: relative; z-index: 1; max-width: 1024px; margin: 0 auto;
      display: grid; place-items: center; gap: 6px;
    }
    header a.logo {
      display: inline-block; text-decoration: none; border: 0; outline: none;
    }
    header img {
      max-width: 170px; height: auto; border: none; background: transparent; box-shadow: none;
    }
    @media (max-width:600px){ header img{ max-width:140px; } }
    header h1 {
      font-size: 21px; font-weight: 800; margin: 2px 0 0; letter-spacing: .2px;
      text-shadow: 1px 1px 4px rgba(0,0,0,.6);
    }
    header p.sub {
      margin: 2px 0 0; font-size: 13px; opacity: .95;
    }

    /* Chat container */
    #n8n-chat-container {
      width: 100%; height: 100%;
      background: #fff;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      box-shadow: 0 -2px 12px rgba(0,0,0,.25);
      overflow: hidden; display: flex;
    }
    #n8n-chat, .n8n-chat { flex: 1; width: 100%; height: 100%; min-height: 0; }

    /* Hide n8n header + branding */
    #n8n-chat .chat-header { display: none !important; }
    #n8n-chat .powered-by { display: none !important; }

    /* Input + send button prominence */
    #n8n-chat .chat-input {
      font-size: 15px; padding: 10px 12px;
    }
    #n8n-chat .chat-input button {
      width: 44px; height: 44px; border-radius: 50%;
      background: #111 !important; color: #fff !important;
      font-size: 18px; display: inline-flex; align-items: center; justify-content: center;
      margin-left: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: background .2s ease;
    }
    #n8n-chat .chat-input button:hover,
    #n8n-chat .chat-input button:focus { background: #333 !important; }

    /* Footer */
    footer {
      background: #111; text-align: center; padding: 10px 8px;
      font-size: 13px; color: #aaa; border-top: 1px solid #222;
    }
    footer span { color: #f0f0f0; font-weight: 500; }

    /* Guard overlay & toast */
    #chat-guard-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.15);
      display: none; z-index: 9999; cursor: wait;
    }
    #chat-guard-toast {
      position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%);
      background: #111; color: #fff; padding: 10px 14px; border-radius: 10px;
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Arial;
      display: none; z-index: 10000;
    }
  </style>
</head>
<body>

  <header>
    <div class="inner">
      <a class="logo" href="https://sarawaktourism.com" target="_blank" rel="noopener">
        <img src="https://sarawakharvestfestival.com.my/wp-content/uploads/2025/05/Sarawak-More-to-Discover-min.png" alt="Sarawak Tourism Logo" />
      </a>
      <h1>Sarawak AI Tourism Assistant</h1>
      <p class="sub">Tanya apa-apa tentang destinasi, acara, dan tip perjalanan di Sarawak.</p>
    </div>
  </header>

  <div id="n8n-chat-container">
    <div id="n8n-chat"></div>
  </div>

  <footer>
    Concept by <span>Mohd Hisyamudin</span> | Powered by <span>AI</span>
  </footer>

  <!-- Guard UI elements -->
  <div id="chat-guard-overlay" aria-hidden="true"></div>
  <div id="chat-guard-toast"></div>

  <!-- n8n Chat JS -->
  <script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    createChat({
      webhookUrl: 'https://n8n.meistericham.com/webhook/a150b85b-434d-4465-8d1c-48c164d94bea/chat',
      target: '#n8n-chat',
      mode: 'fullscreen',
      showWelcomeScreen: false,
      enableStreaming: false,
      loadPreviousSession: true,
      initialMessages: [
        'Selamat datang! üëã Saya Sam Izrin.',
        'Tanya apa-apa pasal Kuching & Sarawak: tempat menarik, makanan, waktu operasi, pengangkutan.',
        'Contoh: ‚ÄúBila show Darul Hana fountain?‚Äù, ‚ÄúMacam mana pergi Bako?‚Äù, ‚ÄúDi mana beli kek lapis?‚Äù'
      ],
      i18n: {
        en: {
          title: '',
          subtitle: '',
          getStarted: '',
          inputPlaceholder: 'Tanya soalan di sini‚Ä¶ contoh: ‚ÄúWaktu fountain Darul Hana‚Äù'
        }
      }
    });
  </script>

  <!-- Anti-spam guard: single-flight + rate-limit for webhook calls -->
  <script>
    (() => {
      // === CONFIG ===
      const HOST = "n8n.meistericham.com";
      const WEBHOOK_PATH = "/webhook/a150b85b-434d-4465-8d1c-48c164d94bea/chat"; // adjust if you change your webhook
      const RATE_LIMIT_MS = 20000;      // 20s between messages per browser
      const INFLIGHT_TIMEOUT_MS = 35000; // safety unlock if network hangs

      // === STATE ===
      let inFlight = false;
      let inFlightTimer = null;
      const lastKey = "chat:lastSentAt";

      const overlay = document.getElementById("chat-guard-overlay");
      const toast = document.getElementById("chat-guard-toast");

      const showToast = (msg) => {
        toast.textContent = msg;
        toast.style.display = "block";
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => (toast.style.display = "none"), 2200);
      };

      const lockUI = () => {
        inFlight = true;
        overlay.style.display = "block";
        inFlightTimer = setTimeout(() => {
          unlockUI(); // auto-release if fetch never resolves
        }, INFLIGHT_TIMEOUT_MS);
      };

      const unlockUI = () => {
        inFlight = false;
        overlay.style.display = "none";
        if (inFlightTimer) clearTimeout(inFlightTimer);
        inFlightTimer = null;
      };

      // Monkey-patch fetch for this page to guard calls to your webhook
      const _fetch = window.fetch.bind(window);
      window.fetch = async (input, init) => {
        try {
          const url = typeof input === "string" ? input : (input?.url || "");
          const u = new URL(url, location.href);

          const isWebhook =
            u.hostname === HOST &&
            u.pathname === WEBHOOK_PATH;

          // Not our webhook ‚Üí continue normally
          if (!isWebhook) return _fetch(input, init);

          // RATE LIMIT
          const now = Date.now();
          const last = parseInt(localStorage.getItem(lastKey) || "0", 10);
          const remain = RATE_LIMIT_MS - (now - last);
          if (remain > 0) {
            showToast(`Slow ya‚Ä¶ cuba lagi dalam ${Math.ceil(remain/1000)}s`);
            return new Response(JSON.stringify({}), {
              status: 429,
              headers: { "Content-Type": "application/json" }
            });
          }

          // SINGLE-FLIGHT
          if (inFlight) {
            showToast("Sedang proses‚Ä¶ tunggu sekejap");
            return new Response(JSON.stringify({}), {
              status: 202,
              headers: { "Content-Type": "application/json" }
            });
          }

          // Proceed with guarded call
          lockUI();
          localStorage.setItem(lastKey, String(now));

          const res = await _fetch(input, init);
          unlockUI();
          return res;

        } catch (e) {
          unlockUI();
          throw e;
        }
      };
    })();
  </script>

</body>
</html>
