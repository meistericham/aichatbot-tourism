<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sarawak AI Tourism Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- n8n Chat UI -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" />

  <!-- reCAPTCHA v3 (use your REAL site key here too) -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Lf0xsErAAAAAM7vVvRIqb5JI_2Kf0p10aGzJ88W"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    body {
      display: grid; grid-template-rows: auto 1fr auto;
      background:#111; color:#fff; font-family:"Segoe UI", Arial, sans-serif;
      min-height:100vh; overflow-x:hidden;
    }
    /* ---- Header ---- */
    header{position:relative;text-align:center;padding:20px 15px;
      background:url("https://i.ibb.co/RGVs3mQn/DUN-AI-revised.png") no-repeat center/cover;color:#fff}
    header::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.55)}
    header .inner{position:relative;z-index:1;max-width:1080px;margin:0 auto}
    header img{max-width:180px;margin-bottom:6px}
    @media (max-width:600px){header img{max-width:150px}}
    header h1{font-size:22px;font-weight:800;text-shadow:1px 1px 4px rgba(0,0,0,.7);margin:5px 0}
    header p.sub{font-size:13px;opacity:.9}

    /* ---- Chat card ---- */
    #chatCard{
      max-width:1080px;width:min(92%,1080px);margin:24px auto;background:#fff;border-radius:20px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);display:flex;flex-direction:column;height:72vh;min-height:560px;
      overflow:hidden;position:relative
    }

    /* ---- reCAPTCHA gate (overlay) ---- */
    #gate{position:absolute;inset:0;z-index:3;display:grid;place-items:center;
      background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.96))}
    #gate.hidden{display:none}
    .gate-card{width:min(560px,92vw);background:#fff;border:1px solid #e9ecf3;border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.08);padding:clamp(18px,4vw,26px);text-align:center;color:#111}
    .gate-title{font-size:18px;font-weight:800;margin:0 0 6px}
    .gate-text{font-size:14px;color:#444;margin:0 0 14px;line-height:1.6}
    .gate-btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 18px;
      font-size:15px;font-weight:700;color:#111;background:#d6ff6b;border:0;border-radius:999px;cursor:pointer;
      box-shadow:0 8px 24px rgba(214,255,107,.25)}
    .gate-btn[disabled]{opacity:.6;cursor:not-allowed}
    .gate-hint{margin-top:10px;font-size:12px;color:#666}

    /* ---- Instruction panel ---- */
    #welcomeNote{position:absolute;top:12px;left:12px;right:12px;z-index:2;background:#f6f9ff;border:1px solid #e5edff;
      color:#26324b;padding:14px 16px;border-radius:12px;font-size:14px;line-height:1.5}
    #welcomeNote.hidden{display:none}

    /* ---- n8n host ---- */
    #n8n-chat{flex:1;display:flex;flex-direction:column;min-height:0}
    #n8n-chat .messages{flex:1;overflow-y:auto;padding:20px}

    /* show footer & input */
    #n8n-chat .chat-footer{display:flex !important;visibility:visible !important;background:#fff !important;border-top:1px solid #eee !important;padding:12px !important}
    #n8n-chat .chat-input{width:100%;display:flex}
    #n8n-chat .chat-input textarea{flex:1;border:1px solid #ddd !important;border-radius:20px !important;padding:10px 14px !important;font-size:15px;resize:none;min-height:44px;max-height:140px}
    #n8n-chat .chat-input button{margin-left:8px;width:44px;height:44px;border-radius:50%;background:#111 !important;color:#fff !important}

    /* hide n8n header/branding/launcher */
    #n8n-chat .chat-header, #n8n-chat [data-testid="powered-by"], #n8n-chat .powered-by,
    .n8n-chat .powered-by, #n8n-chat [data-testid="launcher"], .chat-launcher{display:none !important}

    /* system lines + countdown banner */
    #n8n-chat .message.system{text-align:center;font-size:13px;color:#666 !important;font-style:italic;margin:6px 0}
    #cooldownBanner{position:absolute;right:12px;top:12px;z-index:2;background:#111;color:#fff;font-size:12px;
      padding:8px 10px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.25);display:none}
    #cooldownBanner.show{display:block}

    /* ---- Footer ---- */
    footer{background:#111;text-align:center;padding:10px;font-size:13px;color:#aaa;border-top:1px solid #222}
    footer span{color:#f0f0f0;font-weight:500}
    footer a{color:#fff;text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <a href="https://sarawaktourism.com" target="_blank" rel="noopener">
        <img src="https://sarawakharvestfestival.com.my/wp-content/uploads/2025/05/Sarawak-More-to-Discover-min.png" alt="Sarawak Tourism Logo" />
      </a>
      <h1>Sarawak AI Tourism Assistant</h1>
      <p class="sub">Tanya apa-apa tentang destinasi, acara, dan tip perjalanan di Sarawak.</p>
    </div>
  </header>

  <section id="chatCard">
    <div id="cooldownBanner" aria-live="polite">‚è≥ Tunggu 10 saat antara soalan.</div>

    <div id="welcomeNote">
      <strong>Selamat datang! üëã</strong><br/>
      Tanyakan apa sahaja tentang Kuching &amp; Sarawak (makanan, tempat, pengangkutan, waktu operasi).<br/>
      ‚Ä¢ Jangan spam ‚Äî satu mesej pada satu masa. <strong>Cooldown 10s</strong> selepas setiap hantar.<br/>
      ‚Ä¢ Pautan boleh diklik:
        <a href="https://sarawaktourism.com" target="_blank" rel="noopener">Sarawak Tourism Website</a> |
        <a href="https://forms.gle/yJ3KPyNpUvEoaG9H9" target="_blank" rel="noopener">Kuiz Pelancongan</a>
    </div>

    <!-- reCAPTCHA gate -->
    <div id="gate" role="dialog" aria-modal="true">
      <div class="gate-card">
        <div class="gate-title">Before we start</div>
        <p class="gate-text">Untuk elak spam & bot, sila tekan ‚ÄúStart Chat‚Äù. Kami akan sahkan anda manusia (reCAPTCHA) dan terus buka chat.</p>
        <button id="btnStart" class="gate-btn" type="button">Start Chat</button>
        <div class="gate-hint">Tip: Selepas hantar mesej, tunggu 10s sebelum mesej seterusnya.</div>
      </div>
    </div>

    <div id="n8n-chat"></div>
  </section>

  <footer>
    Concept by <span><a href="https://mohdhisyamudin.com" target="_blank" rel="noopener">Mohd Hisyamudin</a></span> | Powered by <span>AI</span>
  </footer>

  <script type="module">
    /* =========================================================
       SEGMENT A ‚Äî Config
    ==========================================================*/
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    const RECAPTCHA_SITE_KEY = '6Lf0xsErAAAAAM7vVvRIqb5JI_2Kf0p10aGzJ88W'; // must match script tag
    const VERIFY_WEBHOOK     = 'https://n8n.meistericham.com/webhook/verify-captcha';
    const CHAT_WEBHOOK       = 'https://n8n.meistericham.com/webhook/aichatbot';

    // Guards / session
    const COOLDOWN_MS = 10_000, FAILSAFE_UNLOCK_MS = 25_000, IDLE_RESET_MIN = 3;
    const SESSION_KEY = 'sam_session_locked', LAST_ACTIVITY = 'sam_last_activity';

    // Helpers
    const $ = (s,r=document)=>r.querySelector(s);
    const show = el => el && el.classList.add('show');
    const hide = el => el && el.classList.remove('show');

/* =========================================================
   SEGMENT B ‚Äî Utility helpers & system messages  (REPLACED)
==========================================================*/

// Simple shorthands
const $ = (s, r = document) => r.querySelector(s);
const show = el => el && el.classList.add('show');
const hide = el => el && el.classList.remove('show');

// Find a reliable container to append system lines
function getMessagesContainer() {
  const host = document.getElementById('n8n-chat');
  if (!host) return null;

  // Try the common n8n message containers (different builds use different classnames)
  const selectors = [
    '.messages',
    '[data-testid="messages"]',
    '.chat-messages',
    '.n8n-chat-messages',
    '.message-list',
  ];
  for (const s of selectors) {
    const el = host.querySelector(s);
    if (el) return el;
  }

  // Fallback: last scrollable element with children
  const candidates = [...host.querySelectorAll('*')].filter(e => {
    const cs = getComputedStyle(e);
    return (cs.overflowY === 'auto' || cs.overflowY === 'scroll') && e.children.length > 0;
  });
  if (candidates.length) return candidates[candidates.length - 1];

  console.warn('[system] messages container not found; appending to host');
  return host;
}

function injectSystemMessage(text) {
  const container = getMessagesContainer();
  if (!container) return null;
  const div = document.createElement('div');
  div.className = 'message system';
  div.textContent = text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div; // we update this node during countdown
}

// Hide the blue instruction note once the first chat message exists
function installWelcomeAutoHide() {
  const note = $('#welcomeNote'), host = $('#n8n-chat');
  if (!note || !host) return;
  const mo = new MutationObserver(() => {
    if (host.querySelector('.message')) { note.classList.add('hidden'); mo.disconnect(); }
  });
  mo.observe(host, { childList: true, subtree: true });
}

// Session helpers (unchanged)
function isLocked(){ const last=Number(localStorage.getItem(LAST_ACTIVITY)||0);
  if(Date.now()-last>IDLE_RESET_MIN*60_000){ localStorage.removeItem(SESSION_KEY); }
  return !!localStorage.getItem(SESSION_KEY);
}
function lockSession(){ localStorage.setItem(SESSION_KEY,'1'); localStorage.setItem(LAST_ACTIVITY,String(Date.now())); }
function touchSession(){ localStorage.setItem(LAST_ACTIVITY,String(Date.now())); }
function unlockSession(){ localStorage.removeItem(SESSION_KEY); }

    /* =========================================================
       SEGMENT C ‚Äî Countdown state + logic
    ==========================================================*/
    let lastSendAt=0,lastText='',inFlight=false;
    let cooldownEndAt = 0;
    let cooldownTimer = null;
    let cooldownLine  = null;

    const cooldownRemaining = () =>
      Math.max(0, (cooldownEndAt || (lastSendAt+COOLDOWN_MS)) - Date.now());

    function setControlsDisabled(on){
      const root = document.getElementById('n8n-chat');
      const box = root?.querySelector('textarea, input[type="text"]');
      const btn = root?.querySelector('.chat-input button');
      if (box) box.disabled = on;
      if (btn) btn.disabled = on;
    }

    // üëâ controls the visible countdown + disables input
    function startCooldown(seconds = 10){
      if (cooldownTimer) { console.log('[debug] cooldown already running'); return; }
      cooldownEndAt = Date.now() + seconds*1000;
      console.log('[debug] startCooldown', seconds, 'seconds');

      setControlsDisabled(true);

      const update = () => {
        const remainingMs = cooldownRemaining();
        const secs = Math.ceil(remainingMs/1000);
        console.log('[debug] tick', secs);

        // Update system line (inside chat)
        if (!cooldownLine) cooldownLine = injectSystemMessage(`‚è≥ Tunggu ${secs}s sebelum mesej seterusnya.`);
        else cooldownLine.textContent = `‚è≥ Tunggu ${secs}s sebelum mesej seterusnya.`;

        // Update small banner at top-right
        const b=$('#cooldownBanner');
        b.textContent = `‚è≥ Sila tunggu ${secs} saat sebelum hantar soalan baharu.`;
        show(b);

        if (remainingMs <= 0){
          clearInterval(cooldownTimer);
          cooldownTimer=null;
          cooldownLine=null;
          hide(b);
          setControlsDisabled(false);
          injectSystemMessage('‚úÖ Anda boleh hantar mesej baru sekarang.');
        }
      };

      update(); // show immediately
      cooldownTimer = setInterval(update, 1000);
    }

    // Block sends if cooling or a request is still in-flight
    function blockIfCooling(e){
      const rem=cooldownRemaining();
      if(rem>0 || inFlight){
        e?.preventDefault();
        const secs = Math.ceil(rem/1000) || Math.ceil(COOLDOWN_MS/1000);
        const b=$('#cooldownBanner');
        b.textContent=`‚è≥ Sila tunggu ${secs} saat sebelum hantar soalan baharu.`;
        show(b); setTimeout(()=>hide(b), 1200);
        if (!cooldownTimer) cooldownLine = injectSystemMessage(`‚è≥ Tunggu ${secs}s sebelum mesej seterusnya.`);
        return true;
      }
      return false;
    }

/* =========================================================
   SEGMENT D ‚Äî Guards: intercept input & start cooldown AFTER bot reply (REPLACED)
==========================================================*/
function installGuards(){
  const root = document.getElementById('n8n-chat'); 
  if (!root) return;

  const box     = () => root.querySelector('textarea, input[type="text"]');
  const sendBtn = () => root.querySelector('.chat-input button');
  const disable = on => setControlsDisabled(on);

  // Which nodes look like assistant messages?
  const assistantSelectors = [
    '.assistant',
    '.message.assistant',
    '.message.bot',
    '.bot',
    '.from-bot',
    '.message--assistant',
    '[data-source="assistant"]',
    '[data-role="assistant"]',
  ];
  function isAssistantNode(node) {
    if (!(node instanceof HTMLElement)) return false;
    if (assistantSelectors.some(sel => node.matches(sel))) return true;
    if (assistantSelectors.some(sel => node.querySelector(sel))) return true;
    const cls = node.className || '';
    return /\bmessage\b/.test(cls) && !/\buser\b/.test(cls) && !/\bfrom-user\b/.test(cls);
  }

  // --- Observe DOM: start cooldown when reply "settles" (no change for 800ms)
  let currentAssistNode = null;
  let settleTimer = null;
  const SETTLE_MS = 800; // adjust if needed

  const mo = new MutationObserver(mutations => {
    if (!inFlight) return;

    let touchedAssistant = false;

    for (const m of mutations) {
      for (const n of m.addedNodes) {
        if (isAssistantNode(n)) {
          currentAssistNode = n instanceof HTMLElement ? n : currentAssistNode;
          touchedAssistant = true;
        }
      }
      if (currentAssistNode && (m.target === currentAssistNode || currentAssistNode.contains(m.target))) {
        touchedAssistant = true;
      }
    }

    if (touchedAssistant) {
      // Debounce: when updates stop for SETTLE_MS, we consider the reply finished
      if (settleTimer) clearTimeout(settleTimer);
      settleTimer = setTimeout(() => {
        if (inFlight) {
          inFlight = false;        // request done
          touchSession();
          startCooldown(10);       // ‚úÖ start visible 10s timer here
        }
      }, SETTLE_MS);
    }
  });
  mo.observe(root, { childList: true, subtree: true, characterData: true });

  // Safety unlock in case stream stalls; if cooldown is running we stay disabled
  const safety = () => setTimeout(() => { 
    inFlight = false; 
    if (!cooldownTimer) disable(false); 
  }, FAILSAFE_UNLOCK_MS);

  // Intercept ENTER
  root.addEventListener('keydown', (e) => { 
    if (e.key !== 'Enter') return;
    const b = box(); 
    const val = (b?.value || '').trim();
    if (!val) { e.preventDefault(); return; }

    if (!isLocked()) lockSession(); else touchSession();
    if (blockIfCooling(e)) return;

    if (val === lastText && Date.now() - lastSendAt < COOLDOWN_MS) {
      e.preventDefault();
      injectSystemMessage('‚ö†Ô∏è Mesej sama telah dihantar. Cuba ubah soalan.');
      return;
    }

    inFlight   = true;
    lastSendAt = Date.now();
    lastText   = val;
    disable(true);
    safety();
  }, true);

  // Intercept SEND click
  root.addEventListener('click', (e) => {
    const t = e.target;
    if (!(t instanceof HTMLElement) || !t.closest('.chat-input button')) return;

    const b = box(); 
    const val = (b?.value || '').trim();
    if (!val) { e.preventDefault(); return; }

    if (!isLocked()) lockSession(); else touchSession();
    if (blockIfCooling(e)) return;

    if (val === lastText && Date.now() - lastSendAt < COOLDOWN_MS) {
      e.preventDefault();
      injectSystemMessage('‚ö†Ô∏è Mesej sama telah dihantar. Cuba ubah soalan.');
      return;
    }

    inFlight   = true;
    lastSendAt = Date.now();
    lastText   = val;
    disable(true);
    setTimeout(() => { 
      inFlight = false; 
      if (!cooldownTimer) disable(false); 
    }, FAILSAFE_UNLOCK_MS);
  }, true);

  // Idle unlock (3 min)
  setInterval(() => {
    const last = Number(localStorage.getItem(LAST_ACTIVITY) || 0);
    if (Date.now() - last > IDLE_RESET_MIN * 60_000) {
      unlockSession();
      injectSystemMessage('‚ÑπÔ∏è Sesi dinyahaktif selepas tidak aktif. Anda boleh sambung bersembang.');
    }
  }, 30_000);
}

    /* =========================================================
       SEGMENT E ‚Äî Captcha verify + Chat boot
    ==========================================================*/
    async function verifyCaptcha(token){
      try{
        const res=await fetch(VERIFY_WEBHOOK,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ token, action:'start_chat' })
        });
        const data=await res.json().catch(()=>({})); 
        console.log('[captcha] verify result:', data);
        return !!data.success;
      }catch(err){ console.error('Captcha verify error',err); return false; }
    }

    async function openChat(){
      await createChat({
        webhookUrl: CHAT_WEBHOOK,
        target: '#n8n-chat',
        mode: 'embedded',
        showWelcomeScreen: false,
        enableStreaming: true,
        loadPreviousSession: true,
        initialMessages: [
          'Selamat datang! üëã Saya Sam Izrin.',
          'Tanya apa-apa mengenai Pelancongan Kuching & Sarawak: tempat menarik, makanan, waktu operasi, pengangkutan.'
        ],
        i18n: { en: { inputPlaceholder: 'Tanya soalan di sini‚Ä¶ contoh: ‚ÄúWaktu fountain Darul Hana‚Äù' } }
      });
      $('#gate').classList.add('hidden');
      installGuards();
      installWelcomeAutoHide();
    }

    const grecaptchaReady = () =>
      new Promise((resolve)=>{ try{ window.grecaptcha.ready(resolve); } catch{ resolve(); } });

    async function handleStart(){
      const btn = $('#btnStart'); btn.disabled = true;
      try{
        await grecaptchaReady();
        const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action:'start_chat' });
        if(!token){ alert('reCAPTCHA gagal. Cuba semula.'); btn.disabled=false; return; }
        const ok = await verifyCaptcha(token);
        if(!ok){ alert('Verifikasi reCAPTCHA gagal. Sila cuba lagi.'); btn.disabled=false; return; }
        await openChat();
      }catch(err){
        console.error('Start error', err);
        alert('Tidak dapat memulakan chat sekarang. Cuba lagi.');
        btn.disabled = false;
      }
    }

    /* =========================================================
       SEGMENT F ‚Äî Wire Start button
    ==========================================================*/
    document.addEventListener('DOMContentLoaded', ()=>{
      $('#btnStart').addEventListener('click', handleStart);
    });
  </script>
</body>
</html>
